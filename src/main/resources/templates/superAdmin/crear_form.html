<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>Dashboard - NiceAdmin Bootstrap Template</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link th:href="@{/assets/img/favicon.png}" rel="icon">
    <link th:href="@{/assets/img/apple-touch-icon.png}" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
          rel="stylesheet">
    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css">


    <!-- Vendor CSS Files -->
    <link th:href="@{/assets/vendor/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/assets/vendor/bootstrap-icons/bootstrap-icons.css}" rel="stylesheet">
    <link th:href="@{/assets/vendor/boxicons/css/boxicons.min.css}" rel="stylesheet">
    <link th:href="@{/assets/vendor/quill/quill.snow.css}" rel="stylesheet">
    <link th:href="@{/assets/vendor/quill/quill.bubble.css}" rel="stylesheet">
    <link th:href="@{/assets/vendor/remixicon/remixicon.css}" rel="stylesheet">
    <link th:href="@{/assets/vendor/simple-datatables/style.css}" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link th:href="@{/assets/css/stylesuperadmin.css}" rel="stylesheet">

    <!-- =======================================================
    * Template Name: NiceAdmin
    * Updated: Mar 09 2023 with Bootstrap v5.2.3
    * Template URL: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/
    * Author: BootstrapMade.com
    * License: https://bootstrapmade.com/license/
    ======================================================== -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="staticBackdropLabel"></div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary">Loguearse</button>
            </div>
        </div>
    </div>
</div>

<!-- ======= Header ======= -->
<div th:replace="~{superAdmin/fragments/header.html :: header}"></div>
<!-- End Header -->

<!-- ======= Sidebar ======= -->
<div th:replace="~{superAdmin/fragments/sidebar.html :: sidebar}"></div>
<!-- End Sidebar-->
<main id="main" class="main">

    <div class="pagetitle">
        <h1>Clínica INTERPUCP</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item active">Formulario</li>
                <li class="breadcrumb-item active">Crear formulario</li>
            </ol>
        </nav>
    </div>
    <!-- End Page Title -->

    <section class="section">
        <div class="row align-items-center">
            <!-- Fila para los botones -->
            <div class="row mb-3">
                <div class="col-lg-12 d-flex justify-content-start">
                    <!-- Espacio entre los botones -->
                    <div style="flex-grow: 1"></div>
                    <!-- Botón para guardar formulario -->
                    <button id="save-form" type="button" class="btn btn-primary">Guardar formulario</button>
                </div>
            </div>
            <div class="col-lg-6 container" id="my-container">
                <!-- Fila para el formulario -->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title" contentEditable="true">Titulo de formulario</h5>
                                <!-- Botón Agregar Consulta -->
                                <button id="add-query" type="button" class="btn btn-primary mb-3">Agregar consulta
                                </button>
                                <button id="add-field" type="button" class="btn btn-primary mb-3 ml-3">Agregar campo
                                </button>
                                <!-- General Form Elements -->
                                <form id="my-form" th:action="@{/SuperAdminHomePage/guardarFormulario}" method="POST">
                                    <div id="form-rows">
                                        <!-- Un campo de formulario por defecto -->
                                        <div class="row mb-3">
                                            <div class="col-sm-3">
                                                <label class="col-form-label" contentEditable="false">Ruta al Controlador</label>
                                            </div>
                                            <div class="col-sm-6">
                                                <input type="text" class="form-control" name="ruta" required>
                                            </div>
                                        </div>
                                        <!-- Las filas adicionales del formulario se agregarán aquí -->
                                    </div>
                                    <!-- Un campo de formulario por defecto -->
                                    <!-- Las filas adicionales del formulario se agregarán aquí -->
                                    <input type="hidden" id="titulo" name="titulo" required>
                                    <input type="hidden" id="estructura_formulario" name="estructura_formulario"
                                           maxlength="5000" required>
                                    <input type="hidden" id="rutaController" name="rutaController" required>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

</main><!-- End #main -->

<!-- ======= Footer ======= -->
<footer id="footer" class="footer">
    <div class="copyright">
        &copy; Copyright <strong><span>Clínica InterPUCP</span></strong>. All Rights Reserved
    </div>
    <div class="credits">
        <!-- All the links in the footer should remain intact. -->
        <!-- You can delete the links only if you purchased the pro version. -->
        <!-- Licensing information: https://bootstrapmade.com/license/ -->
        <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/ -->
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
    </div>
</footer><!-- End Footer -->

<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
        class="bi bi-arrow-up-short"></i></a>
<script>
    var darkmode = localStorage.getItem('dark-mode') === 'true';

    var headerColor = "[[${headerColor}]]";
    console.log(headerColor);
    localStorage.setItem('headerColor', headerColor);

    /*  console.log(darkmode ? 'Modo oscuro activado' : 'Modo claro activado');
      var sidebarColor = "[[${sidebarColor}]]";
      localStorage.setItem('sidebarColor', sidebarColor);
*/


    var darkModeButton = document.getElementById('dark-mode-button');

    function updateBodyClasses() {
        document.body.classList.toggle('dark-mode', darkmode);
        document.body.classList.toggle('light-mode', !darkmode);
    }

    function updateHeaderColor() {
        var color = darkmode ? '#363537' : headerColor;
        document.getElementById('header').style.backgroundColor = color;
        console.log(darkmode ? 'saludo' : 'despedida');
    }

    /*   function updateSidebarColor() {
           var color = darkmode ? '#363537' : sidebarColor;
           document.getElementById('sidebar').style.backgroundColor = color;
       }*/
    function setDarkMode(newValue) {
        darkmode = newValue;
        localStorage.setItem('dark-mode', newValue);
        updateBodyClasses();
        updateHeaderColor();
        /*
                        updateSidebarColor(); // Añadir esta línea
        */

    }

    updateBodyClasses();
    updateHeaderColor();
    /*
                updateSidebarColor(); // Añadir esta línea
    */
    document.addEventListener('DOMContentLoaded', (event) => {
        document.getElementById('dark-mode-button').checked = darkmode;
        document.getElementById('dark-mode-button').addEventListener('change', function () {
            setDarkMode(this.checked);
        });
    });
</script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        updateEventListeners();
        bindSaveButton();
    });

    function convertFormStructureToJSON() {
        var formRows = document.getElementById('form-rows').children;
        var formStructure = {fields: []};
        var tituloElement = document.querySelector('.card-title');
        var titulo = tituloElement.textContent;

        // Aquí es donde guardas el valor del título en el campo de entrada oculto
        document.getElementById('titulo').value = titulo;
        var rutaElement = document.getElementsByName('ruta')[0];
        var ruta = rutaElement.value;
        // Guarda la ruta en el campo de entrada oculto:
        document.getElementById('rutaController').value = ruta;

        for (var i = 0; i < formRows.length; i++) {
            var row = formRows[i];
            var label = row.querySelector('.col-form-label').textContent;
            // Ignora la fila que tiene el label "Ruta al Controlador"
            if (label === "Ruta al Controlador") {
                continue;
            }
            var input = row.querySelector('.form-control');
            var numberInput = row.querySelector('input[type="number"]'); // Busca un input de tipo 'number'

            formStructure.fields.push({
                type: input.type,
                label: label,
                isLocked: input.disabled, // Guarda el estado del bloqueo
                hasButton: !!numberInput // Guarda si el campo tiene un botón de consulta (asumiendo que el botón está presente si hay una entrada de número)
            });
        }

        document.getElementById('estructura_formulario').value = JSON.stringify(formStructure);
    }
    function updateEventListeners() {
        var formRows = document.getElementById('form-rows');
        var addButtons = formRows.getElementsByClassName('add-row');
        var removeButtons = formRows.getElementsByClassName('remove-row');
        var lockButtons = formRows.getElementsByClassName('lock-row')

        Array.from(addButtons).forEach(function (addButton) {
            // Elimina el event listener antiguo
            var newButton = addButton.cloneNode(true);
            addButton.parentNode.replaceChild(newButton, addButton);
            newButton.addEventListener('click', function (e) {
                // Código para agregar fila
                var newRow = document.createElement('div');
                newRow.className = 'row mb-3';
                newRow.innerHTML = `
    <div class="col-sm-3">
        <label class="col-form-label" contentEditable="true">Nuevo Campo</label>
    </div>
    <div class="col-sm-6">
        <input type="text" class="form-control">
    </div>
    <div class="col-sm-1">
        <button type="button" class="btn btn-circle btn-success add-row" title="Agregar campo"><i class="fas fa-plus"></i></button>
    </div>
    <div class="col-sm-1">
        <button type="button" class="btn btn-circle btn-danger remove-row" title="Eliminar campo"><i class="fas fa-minus"></i></button>
    </div>
    <div class="col-sm-1">
        <button type="button" class="btn btn-circle btn-warning lock-row" title="Bloquear campo"><i class="fas fa-unlock"></i></button>
    </div>`;

                formRows.appendChild(newRow);

                // Actualiza los listeners de eventos
                updateEventListeners();
            });

        });

        Array.from(removeButtons).forEach(function (removeButton) {
            // Elimina el event listener antiguo
            var newButton = removeButton.cloneNode(true);
            removeButton.parentNode.replaceChild(newButton, removeButton);

            // Añade el nuevo event listener
            newButton.addEventListener('click', function (e) {
                // Código para eliminar fila
                e.target.closest('.row').remove();

                // Actualiza los listeners de eventos
                updateEventListeners();

                // Deshabilita el botón de eliminación si solo queda un campo
                var updatedRemoveButtons = formRows.getElementsByClassName('remove-row');
                /* if (updatedRemoveButtons.length === 1) {
                     updatedRemoveButtons[0].disabled = true;
                 }*/
            });
        });

        // Habilita todos los botones de eliminación si hay más de un campo
        /*if (removeButtons.length > 1) {
            for (var i = 0; i < removeButtons.length; i++) {
                removeButtons[i].disabled = false;
            }
        } else if (removeButtons.length === 1) {
            removeButtons[0].disabled = true;
        }*/
        for (var i = 0; i < removeButtons.length; i++) {
            removeButtons[i].disabled = false;
        }
        Array.from(lockButtons).forEach(function (lockButton) {  // Nuevo botón
            lockButton.addEventListener('click', function (e) {
                var row = e.target.closest('.row');
                var input = row.querySelector('.form-control, select');

                if (input.disabled) {
                    input.disabled = false;
                    lockButton.innerHTML = '<i class="fas fa-lock-open"></i>';  // Cambia el ícono a desbloqueado
                } else {
                    input.disabled = true;
                    lockButton.innerHTML = '<i class="fas fa-lock"></i>';  // Cambia el ícono a bloqueado
                }
            });
        });

    }

    function bindSaveButton() {
        var saveButton = document.getElementById('save-form');
        var form = document.getElementById('my-form');

        saveButton.addEventListener('click', function (e) {
            e.preventDefault(); // previene el comportamiento por defecto del botón
            // Realizamos la validación del formulario
            if (!form.checkValidity()) {
                // El formulario no es válido, informamos al usuario en el campo no válido
                form.reportValidity();
            } else {
                // Si el formulario es válido, convertimos la estructura del formulario a JSON y guardamos en los campos ocultos
                convertFormStructureToJSON();

                // Enviamos el formulario
                form.submit();
            }
        });
    }

    document.getElementById('add-query').addEventListener('click', function (e) {
        var formRows = document.getElementById('form-rows');
        var newRow = document.createElement('div');
        newRow.className = 'row mb-3';
        newRow.innerHTML = `
    <div class="col-sm-3">
        <label class="col-form-label" contentEditable="true">Campo de Consulta</label>
    </div>
    <div class="col-sm-6">
        <div class="input-group">
            <input type="number" class="form-control dni">
            <button class="btn btn-primary consulta" type="button">Consulta</button>
        </div>
    </div>
    <div class="col-sm-1">
        <button type="button" class="btn btn-circle btn-success add-row" title="Agregar campo"><i class="fas fa-plus"></i></button>
    </div>
    <div class="col-sm-1">
        <button type="button" class="btn btn-circle btn-danger remove-row" title="Eliminar campo"><i class="fas fa-minus"></i></button>
    </div>`;
        formRows.appendChild(newRow);
        // Actualiza los listeners de eventos
        updateEventListeners();
    });
    document.getElementById('add-field').addEventListener('click', function (e) {
        var formRows = document.getElementById('form-rows');
        var newRow = document.createElement('div');
        newRow.className = 'row mb-3';
        newRow.innerHTML = `
<div class="col-sm-3">
    <label class="col-form-label" contentEditable="true">Nuevo Campo</label>
</div>
<div class="col-sm-6">
    <input type="text" class="form-control">
</div>
<div class="col-sm-1">
    <button type="button" class="btn btn-circle btn-success add-row" title="Agregar campo"><i class="fas fa-plus"></i></button>
</div>
<div class="col-sm-1">
    <button type="button" class="btn btn-circle btn-danger remove-row" title="Eliminar campo"><i class="fas fa-minus"></i></button>
</div>
<div class="col-sm-1">
    <button type="button" class="btn btn-circle btn-warning lock-row" title="Bloquear campo"><i class="fas fa-unlock"></i></button>
</div>`;
        formRows.appendChild(newRow);
        // Actualiza los listeners de eventos
        updateEventListeners();
    });
</script>


<!-- Vendor JS Files -->
<script th:src="@{/assets/vendor/apexcharts/apexcharts.min.js}"></script>
<script th:src="@{/assets/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets/vendor/chart.js/chart.umd.js}"></script>
<script th:src="@{/assets/vendor/echarts/echarts.min.js}"></script>
<script th:src="@{/assets/vendor/quill/quill.min.js}"></script>
<script th:src="@{/assets/vendor/simple-datatables/simple-datatables.js}"></script>
<script th:src="@{/assets/vendor/tinymce/tinymce.min.js}"></script>
<script th:src="@{/assets/vendor/php-email-form/validate.js}"></script>

<!-- Template Main JS File -->
<script th:src="@{/assets/js/main.js}"></script>


</body>

</html>